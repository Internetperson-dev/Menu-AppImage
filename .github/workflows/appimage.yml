name: Build Menu AppImage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Build and package inside linuxdeployqt container
      - name: Build and create AppImage
        uses: addnab/docker-run-action@v3
        with:
          image: probonopd/linuxdeployqt:continuous
          workspace: ${{ github.workspace }}
          options: --privileged
          run: |
            # Install build dependencies
            apt-get update && apt-get install -y \
              build-essential cmake git wget fuse3 \
              qt5-default qttools5-dev qttools5-dev-tools \
              libkf5windowsystem-dev libkf5kdbusaddons-dev \
              libbaloo-dev libxcb1-dev libdbusmenu-qt-dev libpulse-dev pkg-config

            cd $GITHUB_WORKSPACE

            # Build Menu
            mkdir -p build && cd build
            cmake ..
            make -j$(nproc)

            # Install into AppDir for linuxdeployqt
            DESTDIR=$PWD/AppDir make install

            # Create AppImage
            ./linuxdeployqt-continuous-x86_64.AppImage AppDir/usr/share/applications/*.desktop -appimage

      # 3️⃣ Upload AppImage artifact
      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Menu-AppImage
          path: '*.AppImage'
