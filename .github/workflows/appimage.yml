name: Build Menu AppImage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout source
      - uses: actions/checkout@v3

      # 2) Run the build inside KDE Neon Plasma Docker image
      - name: Build and package inside KDE Neon
        uses: addnab/docker-run-action@v3
        with:
          image: kdeneon/plasma:unstable
          options: "--privileged" # needed for FUSE/AppImage
          run: |
            # Update and install any extra dev packages (if needed)
            sudo apt-get update
            sudo apt-get install -y \
              build-essential cmake git wget pkg-config \
              qttools5-dev-tools qttools5-dev \
              libkf5windowsystem-dev libkf5coreaddons-dev \
              libkf5dbusaddons-dev libbaloo5-dev libdbusmenu-qt-dev \
              libxcb1-dev libx11-dev libpulse-dev

            # Prepare build dir
            mkdir -p /mnt/build && cd /mnt/build

            # Configure & build
            cmake /mnt
            make -j$(nproc)

            # Install into AppDir
            DESTDIR=$PWD/AppDir make install

            # Download linuxdeployqt
            wget https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
            chmod +x linuxdeployqt-continuous-x86_64.AppImage

            # Build AppImage
            ./linuxdeployqt-continuous-x86_64.AppImage AppDir/usr/share/applications/*.desktop -appimage

      # 3) Upload AppImage
      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Menu-AppImage
          path: '*.AppImage'
