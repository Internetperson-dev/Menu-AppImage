name: Build Menu AppImage
on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo add-apt-repository universe
          sudo apt-get update
          sudo apt-get install -y \
            cmake g++ qtbase5-dev qttools5-dev \
            libqt5svg5-dev libqt5x11extras5-dev \
            libkf5windowsystem-dev libkf5globalaccel-dev \
            baloo-kf5-dev libxtst-dev libxdamage-dev \
            libxcomposite-dev libxrender-dev libxcb1-dev \
            libx11-xcb-dev libxcb-damage0-dev libxcb-util-dev \
            libxcb-ewmh-dev libdbusmenu-qt5-dev libkf5dbusaddons-dev \
            libpulse-dev libqalculate-dev qtdeclarative5-dev \
            libprocps-dev make pkg-config libicu-dev wget \
            patchelf file zip imagemagick

      - name: Build project
        run: |
          mkdir -p build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)
          make DESTDIR=AppDir install

          # Move the binary so linuxdeployqt can find it
          mkdir -p AppDir/usr/bin
          cp System/Menu.app/Menu AppDir/usr/bin/Menu

      - name: Create temporary .desktop file and icon
        run: |
          mkdir -p build/AppDir/usr/share/applications
          mkdir -p build/AppDir/usr/share/icons/hicolor/256x256/apps

          # Minimal .desktop file (no leading spaces!)
          cat > build/AppDir/usr/share/applications/Menu.desktop <<EOL
[Desktop Entry]
Type=Application
Name=Menu
Exec=Menu
Icon=menu
Comment=Menu application
Categories=Utility;
Terminal=false
EOL

          # Placeholder icon
          convert -size 256x256 xc:none build/AppDir/usr/share/icons/hicolor/256x256/apps/menu.png || true

      - name: Download linuxdeployqt
        run: |
          mkdir -p build/linuxdeployqt
          wget -O build/linuxdeployqt/linuxdeployqt-continuous-x86_64.AppImage \
            https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
          chmod +x build/linuxdeployqt/linuxdeployqt-continuous-x86_64.AppImage

      - name: Create AppImage
        run: |
          cd build/AppDir
          ../linuxdeployqt/linuxdeployqt-continuous-x86_64.AppImage \
            usr/share/applications/Menu.desktop \
            -appimage

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Menu.AppImage
          path: build/AppDir/*.AppImage
