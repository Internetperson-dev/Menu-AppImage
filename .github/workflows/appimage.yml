name: Build Menu AppImage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout code
      - uses: actions/checkout@v3

      # 2) Run build in KDE Neon container
      - name: Build and package in KDE Neon
        uses: addnab/docker-run-action@v3
        with:
          image: kdeneon/plasma:unstable
          options: "--privileged -v ${{ github.workspace }}:/mnt:cached"
          run: |
            set -e

            echo "Entering build directory..."
            mkdir -p /mnt/build && cd /mnt/build

            echo "Configuring with CMake..."
            cmake /mnt

            echo "Building..."
            make -j$(nproc)

            echo "Installing to AppDir..."
            mkdir -p AppDir/usr
            DESTDIR=$PWD/AppDir make install

            echo "AppDir contents:"
            find AppDir

            echo "Downloading linuxdeployqt..."
            wget https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
            chmod +x linuxdeployqt-continuous-x86_64.AppImage

            echo "Creating AppImage..."
            ./linuxdeployqt-continuous-x86_64.AppImage --appimage-extract-and-run AppDir/usr/share/applications/*.desktop -appimage

      # 3) Upload artifact
      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Menu-AppImage
          path: '*.AppImage'
