name: Build Menu AppImage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout code
      - uses: actions/checkout@v3

      # 2) Run build in existing KDE Neon image
      - name: Build and package in KDE Neon
        uses: addnab/docker-run-action@v3
        with:
          image: neon/kde:latest   # Existing KDE Neon image
          options: "--privileged"
          run: |
            # Install any extra dev tools we might need
            apt-get update && apt-get install -y \
              build-essential cmake git wget fuse3 pkg-config

            # Create and enter build dir
            mkdir -p /mnt/build && cd /mnt/build

            # Configure
            cmake /mnt

            # Build
            make -j$(nproc)

            # Install into AppDir
            DESTDIR=$PWD/AppDir make install

            # Get linuxdeployqt
            wget https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
            chmod +x linuxdeployqt-continuous-x86_64.AppImage

            # Create AppImage
            ./linuxdeployqt-continuous-x86_64.AppImage AppDir/usr/share/applications/*.desktop -appimage

      # 3) Upload artifact
      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Menu-AppImage
          path: '*.AppImage'
