name: Build Menu AppImage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout code
      - uses: actions/checkout@v3

      # 2) Build custom KDE Neon image
      - name: Build KDE Neon image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: .github/docker/Dockerfile
          push: false
          tags: menu-kde-neon:ci

      # 3) Run build in custom KDE Neon image
      - name: Build and package
        uses: addnab/docker-run-action@v3
        with:
          image: menu-kde-neon:ci
          options: "--privileged"
          run: |
            # Create and enter build dir
            mkdir -p /mnt/build && cd /mnt/build

            # Configure
            cmake /mnt

            # Build
            make -j$(nproc)

            # Install into AppDir
            DESTDIR=$PWD/AppDir make install

            # Get linuxdeployqt
            wget https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
            chmod +x linuxdeployqt-continuous-x86_64.AppImage

            # Create AppImage
            ./linuxdeployqt-continuous-x86_64.AppImage AppDir/usr/share/applications/*.desktop -appimage

      # 4) Upload artifact
      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Menu-AppImage
          path: '*.AppImage'
